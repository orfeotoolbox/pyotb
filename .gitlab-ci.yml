default:
  image:
    name: $CI_REGISTRY/orfeotoolbox/otb-build-env/otb-ubuntu-native-develop-headless:20.04
  tags:
    - light
  interruptible: true

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - .cache/pip

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_REF_NAME =~ /master/

stages:
  - Static Analysis
  - Tests
  - Documentation test
  - Ship

#  -------------------------------- Static analysis --------------------------------

.static_analysis:
  stage: Static Analysis
  allow_failure: true
  #rules:
  #  - changes:
  #      - pyotb/*.py
  before_script:
    - pip install ".[dev]"

pydocstyle:
  extends: .static_analysis
  script:
    - pydocstyle $PWD/pyotb

pylint:
  extends: .static_analysis
  script:
    - pylint $PWD/pyotb

codespell:
  extends: .static_analysis
  #rules:
  #  - changes:
  #      - pyotb/*.py
  #      - tests/*.py
  #      - doc/*.md
  #      - README.md
  script:
    - codespell {pyotb,tests,doc,README.md}

# -------------------------------------- Tests --------------------------------------

.tests:
  stage: Tests
  allow_failure: false
  #rules:
  #  - changes:
  #      - pyotb/*.py
  #      - tests/*.py
  variables:
    OTB_ROOT: /opt/otb
    LD_LIBRARY_PATH: /opt/otb/lib
    OTB_LOGGER_LEVEL: INFO
    PYOTB_LOGGER_LEVEL: DEBUG
  artifacts:
    reports:
      junit: test-*.xml
  before_script:
    - pip install ".[dev]"

test_core:
  extends: .tests
  script:
    - pytest --color=yes --junitxml=test-core.xml tests/test_core.py

test_numpy:
  extends: .tests
  script:
    - pytest --color=yes --junitxml=test-numpy.xml tests/test_numpy.py

test_pipeline:
  extends: .tests
  script:
    - pytest --color=yes --junitxml=test-pipeline.xml tests/test_pipeline.py

# -------------------------------------- Ship ---------------------------------------

docs:
  stage: Ship
  when: manual
  before_script:
    - apt update && apt install -y python3.8-venv
    - python3 -m venv docs_venv
    - source docs_venv/bin/activate
    - python3 -m pip install -U pip
    - python3 -m pip install -r doc/doc_requirements.txt
  script:
    - mkdocs build --site-dir public
  artifacts:
    paths:
      - public

pypi:
  stage: Ship
  when: manual
  #only:
  #  - master
  before_script:
    - apt update && apt install -y python3.8-venv
    - pip install --upgrade build twine
  script:
    - python3 -m build
    - python3 -m twine upload --non-interactive -u __token__ -p $pypi_token dist/*
