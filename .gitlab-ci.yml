workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID            # Execute jobs in merge request context
    - if: $CI_COMMIT_BRANCH == 'develop'  # Execute jobs when a new commit is pushed to develop branch

image: $CI_REGISTRY/orfeotoolbox/otb-build-env/otb-ubuntu-native-develop:20.04

stages:
  - Static Analysis
  - Documentation
  - Test

# --------------------------------- Static analysis ---------------------------------

.static_analysis_base:
  stage: Static Analysis
  tags:
    - light
  allow_failure: true

flake8:
  extends: .static_analysis_base
  script:
    - pip install flake8
    - python3 -m flake8 --max-line-length=120 $PWD/pyotb --ignore=F403,E402,F401,W503,W504

pylint:
  extends: .static_analysis_base
  script:
    - pip install pylint
    - pylint --max-line-length=120 $PWD/pyotb --disable=too-many-nested-blocks,too-many-locals,too-many-statements,too-few-public-methods,too-many-instance-attributes,too-many-arguments,invalid-name,fixme,too-many-return-statements,too-many-lines,too-many-branches,import-outside-toplevel,wrong-import-position,wrong-import-order,import-error,missing-class-docstring

codespell:
  extends: .static_analysis_base
  script:
    - pip install codespell
    - codespell --skip="*.png,*.jpg,*git/lfs*"

pydocstyle:
  extends: .static_analysis_base
  script:
    - pip install pydocstyle
    - pydocstyle $PWD/pyotb --convention=google


# ------------------------------------------------------- Doc ----------------------------------------------------------
.doc_base:
  stage: Documentation
  tags:
    - light
  before_script:
    - apt-get update && apt-get -y install virtualenv
    - virtualenv doc_env
    - source doc_env/bin/activate
    - pip install --upgrade pip
    - pip install mkdocstrings mkdocstrings[crystal,python] mkdocs-material mkdocs-gen-files mkdocs-section-index mkdocs-literate-nav mkdocs-mermaid2-plugin --upgrade
  artifacts:
    paths:
      - public
      - public_test

test:
  extends: .doc_base
  rules:
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
  script:
    - mkdocs build --site-dir public_test

pages:
  extends: .doc_base
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  script:
    - mkdocs build --site-dir public


# --------------------------------- Test ---------------------------------

.test_base:
  stage: Test
  tags:
    - light
  allow_failure: false
  before_script:
    - pip install .
    - cd tests
  variables:
    OTB_ROOT: /opt/otb
    LD_LIBRARY_PATH: /opt/otb/lib
    PYOTB_LOGGER_LEVEL: DEBUG
    OTB_LOGGER_LEVEL: INFO

import_pyotb:
  extends: .test_base
  script:
    - python3 -c "import pyotb"

compute_ndvi:
  extends: .test_base
  script:
    - python3 ndvi_test.py

numpy_array:
  extends: .test_base
  script:
    - python3 numpy_array_test.py

pipeline_test_shape:
  extends: .test_base
  script:
    - python3 pipeline_test.py shape

pipeline_test_shape_backward:
  extends: .test_base
  script:
    - python3 pipeline_test.py shape backward

pipeline_test_shape_nointermediate:
  extends: .test_base
  script:
    - python3 pipeline_test.py shape no-intermediate-result

pipeline_test_shape_backward_nointermediate:
  extends: .test_base
  script:
    - python3 pipeline_test.py shape backward no-intermediate-result

pipeline_test_write:
  extends: .test_base
  script:
    - python3 pipeline_test.py write

pipeline_test_write_backward:
  extends: .test_base
  script:
    - python3 pipeline_test.py write backward

pipeline_test_write_nointermediate:
  extends: .test_base
  script:
    - python3 pipeline_test.py write no-intermediate-result

pipeline_test_write_backward_nointermediate:
  extends: .test_base
  script:
    - python3 pipeline_test.py write backward no-intermediate-result

