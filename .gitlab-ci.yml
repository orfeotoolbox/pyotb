default:
  image: $CI_REGISTRY/orfeotoolbox/otb-build-env/otb-ubuntu-native-develop-headless:20.04
  tags:
    - light
  interruptible: true
  before_script:
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install ".[dev]"
  cache:
    key: $CI_COMMIT_SHA
    paths:
      - venv

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_REF_NAME =~ /master/

stages:
  - Static Analysis
  - Documentation test
  - Tests
  - Ship

#  -------------------------------- Static analysis --------------------------------

.static_analysis:
  stage: Static Analysis
  allow_failure: true

codespell:
  #rules:
  #  - changes:
  #      - pyotb/*.py
  #      - tests/*.py
  #      - doc/*.md
  #      - README.md
  extends: .static_analysis
  script:
    - codespell {pyotb,tests,doc,README.md}

flake8:
  #rules:
  #  - changes:
  #      - pyotb/*.py
  extends: .static_analysis
  script:
    - flake8 --max-line-length=120 $PWD/pyotb --ignore=F403,E402,F401,W503,W504

pydocstyle:
  #rules:
  #  - changes:
  #      - pyotb/*.py
  extends: .static_analysis
  script:
    - pydocstyle $PWD/pyotb

pylint:
  #rules:
  #  - changes:
  #      - pyotb/*.py
  extends: .static_analysis
  script:
    - pylint $PWD/pyotb

# -------------------------------------- Tests --------------------------------------

.tests:
  stage: Tests
  #rules:
  #  - changes:
  #      - pyotb/*.py
  #      - tests/*.py
  allow_failure: false
  variables:
    OTB_ROOT: /opt/otb
    LD_LIBRARY_PATH: /opt/otb/lib
    OTB_LOGGER_LEVEL: INFO
    PYOTB_LOGGER_LEVEL: DEBUG
  artifacts:
    reports:
      junit: test-*.xml

test_core:
  extends: .tests
  script:
    - pytest --color=yes --junitxml=test-core.xml tests/test_core.py

test_numpy:
  extends: .tests
  script:
    - pytest --color=yes --junitxml=test-numpy.xml tests/test_numpy.py

test_pipeline:
  #when: manual
  extends: .tests
  script:
    - pytest --color=yes --junitxml=test-pipeline.xml tests/test_pipeline.py

# ---------------------------------- Documentation  ----------------------------------
.docs:
  before_script:
    - pip install -U pip virutalenv
    - virtualenv docs_venv
    - source docs_venv/bin/activate
    - pip install -U -r doc/doc_requirements.txt
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - docs_venv

docs_test:
  stage: Documentation test
  extends: .docs
  when: manual
  script:
    - pip install -U -r doc/doc_requirements.txt
    - mkdocs build --site-dir public_test
  artifacts:
    paths:
      - public_test

# -------------------------------------- Ship ---------------------------------------

docs:
  stage: Ship
  extends: .docs
  when: manual
  only:
    - master
  script:
    - mkdocs build --site-dir public
  artifacts:
    paths:
      - public

pypi:
  stage: Ship
  #only:
  # - master
  before_script:
   - pip install --upgrade build twine
  script:
    - python3 -m build
    #- python3 -m twine upload --repository-url https://upload.pypi.org/legacy/ --non-interactive -u __token__ -p $pypi_token dist/*
  artifacts:
    paths:
      - dist/
